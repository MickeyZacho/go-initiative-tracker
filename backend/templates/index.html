<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initiative Tracker</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/scripts.js"></script>
</head>

<body>
    <h1>Initiative Tracker</h1>
    {{ if .Username }}
    <div>Welcome, {{ .Username }}! <a href="/logout">Logout</a></div>
    {{ else }}
    <a href="/login/discord">Login with Discord</a>
    {{ end }}
    <div id="encounter-list" hx-get="/encounters" hx-trigger="load" hx-target="#encounter-list" hx-swap="innerHTML">
        <!-- Encounter list will be loaded here -->
    </div>
    <button onclick="window.sortCharactersByInitiative()">Sort by Initiative</button>
    <button onclick="window.dispatchEvent(new CustomEvent('next-character'))">Next Character</button>
    <button onclick="window.dispatchEvent(new CustomEvent('add-character'))">Add Character</button>
    <button id="show-add-existing-character">Add Existing Character</button>
    <div id="add-existing-character-modal"
        style="display:none; background:#fff; border:1px solid #ccc; padding:10px; position:absolute; z-index:1000;">
        <input type="text" id="search-character-i   nput" placeholder="Search characters...">
        <div id="search-character-results"></div>
        <button onclick="closeAddExistingCharacterModal()">Close</button>
    </div>
    <div id="character-list-container" hx-get="/characters" hx-trigger="load">
        <!-- Character list will be loaded here -->
    </div>
    <script>
        // Attach next-character event listener to #character-list after every HTMX swap
        function attachNextCharacterListener() {
            const el = document.getElementById('character-list');
            if (!el) return;
            // Remove any previous listener to avoid duplicates
            el.removeEventListener('next-character', el._nextCharHandler);
            el._nextCharHandler = function () {
                if (this.__x && this.__x.$data && typeof this.__x.$data.nextCharacter === 'function') {
                    this.__x.$data.nextCharacter();
                }
            };
            el.addEventListener('next-character', el._nextCharHandler);
        }
        // Attach on initial load
        attachNextCharacterListener();
        // Attach after every HTMX swap or settle
        document.body.addEventListener('htmx:afterSwap', attachNextCharacterListener);
        document.body.addEventListener('htmx:afterSettle', attachNextCharacterListener);
        // Sort characters by initiative using Alpine.js
        window.sortCharactersByInitiative = function () {
            const characterListEl = document.getElementById('character-list');
            if (characterListEl && characterListEl.__x) {
                const data = characterListEl.__x.$data;
                data.characters.sort((a, b) => b.Initiative - a.Initiative);
            }
        };
        // Removed initializeSortable() calls; sortable logic is now handled in character-list.html
        document.body.addEventListener('htmx:afterSettle', function (event) {
            if (event.detail.requestConfig && event.detail.requestConfig.path === '/add-character') {
                const newCharacter = event.detail.target.lastElementChild;
                newCharacter.querySelector('.edit-mode').style.display = 'block';
                newCharacter.querySelector('.view-mode').style.display = 'none';
            }
        });

        document.body.addEventListener('keydown', function (event) {
            // on press spacebar, trigger next character (Alpine.js v3 way)
            if (event.code === 'Space') {
                window.dispatchEvent(new CustomEvent('next-character'));
            }
            // on press e, trigger edit mode
            if (event.code === 'KeyE') {
                const characterDiv = document.querySelector('.character.active');
                // prevent default if there is an active character and it is not in edit mode
                if (characterDiv && characterDiv.querySelector('.edit-mode').style.display === 'none') {
                    event.preventDefault();

                    characterDiv.querySelector('.edit-mode').style.display = '';
                    characterDiv.querySelector('.view-mode').style.display = 'none';
                    characterDiv.querySelector('.edit-mode input[name="name"]').focus();
                }
            }
            // on press escape, cancel edit mode
            if (event.code === 'Escape') {
                const characterDiv = document.querySelector('.character.active');
                // if there is an active character and it is in edit mode
                if (characterDiv && characterDiv.querySelector('.edit-mode').style.display !== 'none') {
                    characterDiv.querySelector('.edit-mode').style.display = 'none';
                    characterDiv.querySelector('.view-mode').style.display = '';
                }
            }
        });

        // Add Existing Character modal logic
        document.getElementById('show-add-existing-character').onclick = function () {
            document.getElementById('add-existing-character-modal').style.display = 'block';
            document.getElementById('search-character-input').value = '';
            document.getElementById('search-character-results').innerHTML = '';
            // Trigger search on modal open
            document.getElementById('search-character-input').oninput();
        };
        function closeAddExistingCharacterModal() {
            document.getElementById('add-existing-character-modal').style.display = 'none';
        }
        document.getElementById('search-character-input').oninput = function () {
            const q = this.value;
            fetch('/search-characters?q=' + encodeURIComponent(q))
                .then(resp => resp.text())
                .then(html => {
                    document.getElementById('search-character-results').innerHTML = html;
                });
        };
        window.addCharacterToEncounter = function (characterId) {
            fetch('/add-character-to-encounter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ character_id: characterId })
            })
                .then(resp => resp.text())
                .then(html => {
                    document.getElementById('character-list').innerHTML = html;
                    closeAddExistingCharacterModal();
                });
        };
    </script>
</body>

</html>